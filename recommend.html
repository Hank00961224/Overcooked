<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æ™‚å°šç©¿æ­æ¨è–¦</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg1: #181a1b;
            --bg2: #232526;
            --card: #232526;
            --accent1: #fff;
            --accent2: #bbb;
            --text: #f5f5f5;
            --muted: #aaa;
        }


        * { box-sizing: border-box; }


        body {
            margin: 0;
            font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            color: var(--text);
            padding: 0;
            display: flex;
            align-items: start;
            justify-content: center;
        }


        .container {
            width: 100vw;
            max-width: 1600px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            padding: 48px 24px 24px 24px;
            height: auto;
            margin-top: 56px;
        }


        .panel {
            background: var(--card);
            border-radius: 16px;
            padding: 32px 28px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.12);
            border: 1px solid #222;
        }


        .title {
            font-size: 26px;
            color: var(--text);
            margin-bottom: 14px;
            font-weight: 700;
            letter-spacing: 0.5px;
            font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
        }
        .subtitle {
            font-size: 16px;
            color: var(--muted);
            margin-bottom: 28px;
            line-height: 1.8;
            font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
        }
        .result-card {
            background: var(--card);
            border-radius: 14px;
            padding: 28px;
            border: 1px solid #222;
            box-shadow: 0 2px 16px rgba(0,0,0,0.18);
        }


        .composite-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-top: 24px;
        }
        .uploaded-preview, .composite-preview {
            width: 100%;
            background: #222;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 2px 12px rgba(0,0,0,0.22);
        }
        .uploaded-preview img, .composite-preview img {
            width: 100%;
            height: 520px;
            object-fit: contain;
            border-radius: 14px;
            background: #1a1c1d;
        }


        .back-home {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            top: 18px;
            padding: 8px 24px;
            background: #222;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: none;
        }
        .back-home:hover {
            background: #444;
        }


        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .input, .select {
            width: 100%;
            padding: 10px 12px;
            background: #181a1b;
            border: 1px solid #333;
            border-radius: 7px;
            color: var(--text);
            font-size: 15px;
        }
        .select option {
            background-color: #222;
            color: var(--text);
        }
        .input::placeholder {
            color: #666;
        }
        .input:focus, .select:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 0 2px #333;
        }


        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            background: #222;
            color: #fff;
            transition: background 0.2s;
            margin-right: 8px;
        }
        .btn.primary {
            background: #222;
            color: #fff;
            border: 1px solid #333; /* æ–°å¢ï¼šèˆ‡ .btn.secondary ä¸€æ¨£çš„å¤–æ¡† */
        }
        .btn.secondary {
            background: #181a1b;
            color: #fff;
            border: 1px solid #333;
        }
        .btn:hover {
            background: #444;
            color: #fff;
        }


        /* æ–°å¢ï¼šç½®ä¸­è¡¨å–®æœ«ç«¯æŒ‰éˆ•ï¼ˆç”Ÿæˆ / é‡æ–°è¨­å®šï¼‰ä¸¦ä½¿ç”¨ gap æ§åˆ¶é–“è· */
        .search-form .form-group:last-child {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 8px;
            transform: translateX(-0.35cm); /* å‘å³ç§» 0.25cmï¼ˆå·²ä¿®æ”¹ï¼‰ */
        }
        .search-form .form-group:last-child .btn {
            margin-right: 0;
        }


        .photo-upload {
            background: #181a1b;
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 18px;
            color: var(--muted);
            position: relative;
        }
        .photo-upload:hover {
            background: #222;
        }
        .photo-preview {
            max-width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            display: none;
            margin-top: 8px;
            background: #181a1b;
        }
        .upload-icon {
            font-size: 40px;
            color: var(--muted);
        }

        /* æ–°å¢ï¼šé‡é¸ç…§ç‰‡æŒ‰éˆ•æ¨£å¼ */
        .reset-photo-btn {
            display: none;
            margin-top: 12px;
            padding: 8px 16px;
            background: #222;
            color: #fff;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .reset-photo-btn:hover {
            background: #444;
        }


        .loading-overlay {
            position: relative;
            min-height: 120px;
        }
        .loading-overlay .loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.28);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            gap: 10px;
        }
        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #333;
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }


        @media (max-width: 980px) {
            .container {
                grid-template-columns: 1fr;
            }
            .composite-row {
                grid-template-columns: 1fr;
            }
            .uploaded-preview img, .composite-preview img {
                height: 360px;
            }
        }
    </style>
</head>
<body>
    <!-- ç§»å‹•è¿”å›æŒ‰éˆ•åˆ°é ‚éƒ¨ä¸­é–“ -->
    <a href="index.html" class="back-home">è¿”å›é¦–é </a>


    <div class="container">
        <!-- å·¦å´çµæœé¢æ¿ -->
        <div class="panel">
            <h1 class="title">ä»Šæ—¥ç©¿æ­æ¨è–¦</h1>
            <p class="subtitle">æ ¹æ“šæ‚¨çš„å€‹äººç‰¹å¾µèˆ‡ç•¶åœ°å¤©æ°£ï¼Œç‚ºæ‚¨æ¨è–¦æœ€é©åˆçš„ç©¿æ­çµ„åˆã€‚</p>


            <div class="result-card">
                <div id="outfitResult">
                    <!-- å‹•æ…‹ç”Ÿæˆç©¿æ­é è¦½ -->
                </div>


                <!-- å¤©æ°£é¡¯ç¤ºå€ -->
                <div id="weatherInfo" style="margin-top:12px;color:var(--muted);font-size:14px">
                    <!-- å¤©æ°£è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                </div>
            </div>
        </div>


        <!-- å³å´è¨­å®šé¢æ¿ -->
        <div class="panel">
            <h2 class="title">æ­é…æ¢ä»¶è¨­å®š</h2>
            <p class="subtitle">è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨æ¨è–¦æœ€é©åˆçš„ç©¿æ­ã€‚</p>


            <!-- ä¿®æ”¹ï¼šåœ¨è¡¨å–®ä¸­æ–°å¢æ—ç¾¤é¸æ“‡ -->
            <form class="search-form" id="outfitForm">
                <div class="form-group">
                    <label>ä¸Šå‚³æ‚¨çš„ç…§ç‰‡</label>
                    <div class="photo-upload" id="photoUploadArea">
                        <span class="material-icons upload-icon">cloud_upload</span>
                        <p style="margin-top: 10px; color: var(--muted);">é»æ“Šæˆ–æ‹–æ›³ç…§ç‰‡è‡³æ­¤è™•</p>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <img id="photoPreview" class="photo-preview">
                        <button type="button" class="reset-photo-btn" id="resetPhotoBtn">é‡æ–°é¸æ“‡ç…§ç‰‡</button>
                    </div>
                </div>


                <div class="form-group">
                    <label>æ€§åˆ¥</label>
                    <select class="select" name="gender" required>
                        <option value="male">ç”·è£</option>
                        <option value="female">å¥³è£</option>
                        <option value="unisex">ä¸­æ€§é¢¨æ ¼</option>
                    </select>
                </div>


                <!-- æ–°å¢æµè¡Œé¢¨æ ¼é¸æ“‡ -->
                <div class="form-group">
                    <label>æµè¡Œé¢¨æ ¼</label>
                    <select class="select" name="trend">
                        <option value="">ä¸æŒ‡å®š</option>
                        <option value="korean">éŸ“ç³»</option>
                        <option value="japanese">æ—¥ç³»</option>
                        <option value="american">ç¾ç³»</option>
                        <option value="european">æ­ç³»</option>
                    </select>
                </div>


                <!-- æ–°å¢ç©¿è‘—å–œå¥½é¸æ“‡ -->
                <div class="form-group">
                    <label>ç©¿è‘—å–œå¥½</label>
                    <select class="select" name="style">
                        <option value="">ä¸æŒ‡å®š</option>
                        <option value="casual">ä¼‘é–’é¢¨</option>
                        <option value="punk">é¾å…‹é¢¨</option>
                        <option value="minimalist">ç°¡ç´„é¢¨</option>
                        <option value="vintage">å¾©å¤é¢¨</option>
                        <option value="sporty">é‹å‹•é¢¨</option>
                        <option value="street">è¡—é ­é¢¨</option>
                        <option value="bohemian">æ³¢å¸Œç±³äºé¢¨</option>
                        <option value="preppy">å­¸é™¢é¢¨</option>
                    </select>
                </div>


                <div class="form-group">
                    <label>å ´åˆé¸æ“‡</label>
                    <select class="select" name="occasion" required>
                        <option value="">è«‹é¸æ“‡å ´åˆ</option>
                        <option value="daily">æ—¥å¸¸ä¼‘é–’</option>
                        <option value="work">å·¥ä½œå ´åˆ</option>
                        <option value="date">ç´„æœƒ</option>
                        <option value="party">æ´¾å°èšæœƒ</option>
                        <option value="ceremony">æ­£å¼å…¸ç¦®</option>
                        <option value="sports">é‹å‹•å¥èº«</option>
                        <option value="travel">æ—…éŠå‡ºéŠ</option>
                    </select>
                </div>


                <div class="form-group">
                    <label>èº«é«˜ (cm)</label>
                    <input type="number" class="input" name="height" placeholder="è«‹è¼¸å…¥èº«é«˜" required>
                </div>


                <div class="form-group">
                    <label>é«”é‡ (kg)</label>
                    <input type="number" class="input" name="weight" placeholder="è«‹è¼¸å…¥é«”é‡" required>
                </div>


                <div class="form-group">
                    <label>æ‰€åœ¨åœ°å€</label>
                    <input type="text" class="input" name="location" placeholder="è¼¸å…¥åŸå¸‚åç¨±" required>
                </div>


                <div class="form-group">
                    <button type="submit" class="btn primary">ç”Ÿæˆç©¿æ­å»ºè­°</button>
                    <button type="reset" class="btn secondary">é‡æ–°è¨­å®š</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Unsplash èˆ‡ Pexels API Keyï¼ˆPexels å¯ç”³è«‹å…è²» keyï¼Œé€™è£¡ç”¨ demo keyï¼‰
        const UNSPLASH_ACCESS_KEY = 'AMSaKomiM1b5LLX57gpT-TxdE0TQ4kHCmaf_b4iORTI';
        const PEXELS_ACCESS_KEY = '563492ad6f91700001000001'; // demo key, è«‹æ›æˆè‡ªå·±çš„æ­£å¼ key


        // æ–°å¢é è¨­ç©¿æ­ï¼Œä»¥é˜² API è«‹æ±‚å¤±æ•—
        const defaultOutfits = {
            casual: [
                { image: 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f', name: 'ä¼‘é–’ç©¿æ­', description: 'æ—¥å¸¸ä¼‘é–’é¢¨æ ¼' },
                { image: 'https://images.unsplash.com/photo-1523381210434-271e8be1f52b', name: 'è¡—é ­é¢¨æ ¼', description: 'è¡—é ­ä¼‘é–’æ­é…' },
                { image: 'https://images.unsplash.com/photo-1492707892479-7bc8d5a4ee93', name: 'è¼•ä¾¿æ­é…', description: 'è¼•é¬†è‡ªåœ¨é¢¨æ ¼' }
            ],
            formal: [
                { image: 'https://images.unsplash.com/photo-1553484771-371a605b060b', name: 'æ­£å¼ç©¿æ­', description: 'å•†å‹™æ­£å¼é¢¨æ ¼' },
                { image: 'https://images.unsplash.com/photo-1553484771-8bbd4e16c6a2', name: 'è¥¿è£å¥—è£', description: 'è·å ´æ­£å¼æ­é…' },
                { image: 'https://images.unsplash.com/photo-1553484771-8bbd4e16c6a3', name: 'å•†å‹™ä¾¿è£', description: 'å•†å‹™ä¼‘é–’é¢¨æ ¼' }
            ]
        };


        // ç¤ºæ„äººç‰© fallbackï¼ˆé¿å…å¤–éƒ¨ API å¤±æ•—æ™‚ç„¡åœ–ï¼‰
        const FALLBACK_PERSON_IMAGE = 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=800&q=60';


        // è¡¨å–®æäº¤è™•ç† + å–å¾—å¤©æ°£èˆ‡èº«å½¢ã€å¤©æ°£ token
        document.getElementById('outfitForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const heightNum = Number(data.height);
            const weightNum = Number(data.weight);
            const bodyTokens = deriveBodyTokens(heightNum, weightNum);

            const weatherTarget = document.getElementById('weatherInfo');
            weatherTarget.textContent = 'æ­£åœ¨æŸ¥è©¢å¤©æ°£...';

            let enriched = { ...data, height: heightNum, weight: weightNum, bodyTokens, weatherTokens: [] };
            try {
                const weather = await fetchWeather(data.location);
                const weatherTokens = deriveWeatherTokens(weather.temperature);
                const tempText = weather.temperature !== null ? `${weather.temperature.toFixed(1)}Â°C` : 'â€”';
                const humidText = weather.humidity !== null ? `${weather.humidity}%` : 'â€”';
                weatherTarget.innerHTML = `<strong>å¤©æ°£ï¼ˆ${weather.name.split(',')[0]}ï¼‰</strong>ï¼šæº«åº¦ ${tempText}ï¼Œæ¿•åº¦ ${humidText}`;
                enriched = { ...enriched, temperature: weather.temperature, humidity: weather.humidity, locationName: weather.name, weatherTokens };
            } catch (err) {
                weatherTarget.textContent = 'ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™';
                console.warn(err);
            }

            generateOutfit(enriched);
        });


        // èº«å½¢èˆ‡å¤©æ°£æè¿° token
        function deriveBodyTokens(height, weight) {
            const h = Number(height);
            const w = Number(weight);
            const tokens = [];
            if (!Number.isFinite(h) || !Number.isFinite(w)) return tokens;
            if (h >= 180) tokens.push('tall');
            else if (h <= 160) tokens.push('petite');
            else tokens.push('average height');
            const bmi = w / Math.pow(h / 100, 2);
            if (bmi < 19) tokens.push('slim');
            else if (bmi < 24.5) tokens.push('fit');
            else tokens.push('curvy');
            return tokens;
        }
        function deriveWeatherTokens(temp) {
            const t = Number(temp);
            if (!Number.isFinite(t)) return [];
            if (t >= 30) return ['summer', 'hot'];
            if (t >= 22) return ['warm', 'spring'];
            if (t >= 12) return ['cool', 'autumn'];
            return ['winter', 'cold'];
        }
        const OCCASION_TOKEN = {
            work: 'office',
            party: 'party wear',
            date: 'date outfit',
            ceremony: 'formal event',
            sports: 'sport',
            travel: 'travel',
            daily: 'casual'
        };
        const TREND_TOKEN = {
            korean: 'korean style',
            japanese: 'japanese style',
            american: 'american style',
            european: 'european style'
        };
        const STYLE_TOKEN = {
            casual: 'casual',
            punk: 'punk style',
            minimalist: 'minimalist',
            vintage: 'vintage style',
            sporty: 'sporty',
            street: 'streetwear',
            bohemian: 'boho style',
            preppy: 'preppy style'
        };

        // å„ªåŒ– fetchOneImageï¼šæ”¹ç”¨æœå°‹ä¸¦å›ºå®šæ’åº
        async function fetchOneImage(term) {
            try {
                const res = await fetch(
                    `https://api.unsplash.com/search/photos?query=${encodeURIComponent(term)}&orientation=portrait&order_by=relevant&per_page=1&page=1`,
                    { headers: { 'Authorization': `Client-ID ${UNSPLASH_ACCESS_KEY}` } }
                );
                if (!res.ok) {
                    console.warn('Unsplash API returned', res.status, res.statusText, 'for term', term);
                } else {
                    const j = await res.json();
                    if (j && j.results && j.results[0] && j.results[0].urls && j.results[0].urls.regular) {
                        const r0 = j.results[0];
                        return {
                            image: r0.urls.regular,
                            name: r0.alt_description || term,
                            credit: r0.user && r0.user.name ? `Photo by ${r0.user.name} on Unsplash` : '',
                            source: 'unsplash'
                        };
                    }
                }
            } catch (e) {
                console.warn('Unsplash fetch failed for', term, e);
            }
            // Pexels search (non-random)
            try {
                const res2 = await fetch(
                    `https://api.pexels.com/v1/search?query=${encodeURIComponent(term)}&orientation=portrait&per_page=1&page=1`,
                    { headers: { 'Authorization': PEXELS_ACCESS_KEY } }
                );
                if (!res2.ok) {
                    console.warn('Pexels API returned', res2.status, res2.statusText, 'for term', term);
                } else {
                    const j2 = await res2.json();
                    if (j2 && j2.photos && j2.photos.length > 0) {
                        const p = j2.photos[0];
                        return {
                            image: p.src && p.src.large ? p.src.large : null,
                            name: p.alt || term,
                            credit: p.photographer ? `Photo by ${p.photographer} on Pexels` : '',
                            source: 'pexels'
                        };
                    }
                }
            } catch (e) {
                console.warn('Pexels fetch failed for', term, e);
            }
            return null;
        }


        // å° helperï¼šæŠŠæ€§åˆ¥å€¼è½‰ç‚ºä¸­æ–‡é¡¯ç¤º
        function genderLabelText(g) {
            if (!g) return 'ä¸­æ€§';
            if (g === 'male') return 'ç”·ç”Ÿ';
            if (g === 'female') return 'å¥³ç”Ÿ';
            return 'ä¸­æ€§';
        }


        // æ–°å¢ï¼šæ ¹æ“šè¡¨å–® gender ç”¢ç”Ÿå¤šå€‹æŸ¥è©¢ tokenï¼ˆæé«˜å‘½ä¸­æ­£ç¢ºæ€§ï¼‰
        function genderTokens(gender) {
            if (gender === 'male') return ["male", "man", "men", "men's", "male model"];
            if (gender === 'female') return ["female", "woman", "women", "women's", "female model"];
            return ["unisex", "person", "model"];
        }


        // æ–°å¢ï¼šä¾å›å‚³çš„æ–‡å­—è³‡è¨Šåˆ¤æ–·æ˜¯å¦ç‚ºã€Œç›¸åã€æ€§åˆ¥ï¼ˆç°¡æ˜“å•Ÿç™¼å¼ï¼‰
        function isOppositeGender(desiredGender, imageMeta) {
            if (!desiredGender || desiredGender === 'unisex') return false;
            const text = ((imageMeta && (imageMeta.name || imageMeta.credit)) || '').toLowerCase();
            if (!text) return false;
            const femaleWords = ['female', 'woman', 'women', 'lady', 'girl'];
            const maleWords = ['male', 'man', 'men', 'boy', 'gentleman', 'guy'];
            if (desiredGender === 'male') {
                return femaleWords.some(w => text.includes(w));
            }
            if (desiredGender === 'female') {
                return maleWords.some(w => text.includes(w));
            }
            return false;
        }


        // ä¿®æ”¹ fetchPersonImageï¼šä½¿ç”¨å¤šå€‹ gender token èˆ‡æ¨¡æ¿ï¼Œä¸¦æª¢æŸ¥æ˜¯å¦ç‚ºç›¸åæ€§åˆ¥ï¼ˆè‹¥æ˜¯å‰‡è·³éï¼‰
        async function fetchPersonImage(gender, style, trend, occasion, bodyTokens = [], weatherTokens = []) {
            const tokens = genderTokens(gender);
            const occasionToken = occasion ? ` ${OCCASION_TOKEN[occasion] || occasion}` : '';
            const trendToken = trend ? ` ${TREND_TOKEN[trend] || trend}` : '';
            const styleToken = style ? ` ${STYLE_TOKEN[style] || style}` : '';
            const ctx = `${bodyTokens.join(' ')} ${weatherTokens.join(' ')}`.trim();

            const templates = [
                (token) => `${token} ${ctx}${occasionToken}${trendToken}${styleToken} fashion model outfit portrait`,
                (token) => `${token} ${ctx}${occasionToken}${styleToken} person wearing outfit`,
                (token) => `${token} ${ctx}${occasionToken}${trendToken}${styleToken} full body portrait outfit`,
                (token) => `${token} ${ctx}${occasionToken} outfit portrait`,
                (token) => `${token} ${ctx} ${styleToken} streetstyle outfit`
            ];


            for (const tk of tokens) {
                for (const tpl of templates) {
                    const q = tpl(tk).replace(/\s+/g, ' ').trim();
                    const r = await fetchOneImage(q);
                    if (r && r.image) {
                        // æª¢æŸ¥æ˜¯å¦å¯èƒ½ç‚ºç›¸åæ€§åˆ¥ï¼Œè‹¥æ˜¯å‰‡ç•¥éå˜—è©¦ä¸‹ä¸€å€‹çµæœ
                        if (isOppositeGender(gender, r)) {
                            console.warn('Fetched image likely opposite gender, skipping:', q, r);
                            continue;
                        }
                        return r;
                    }
                }
            }
            console.warn('No person image found for tokens, using fallback person image');
            return { image: FALLBACK_PERSON_IMAGE, name: 'ç¤ºæ„äººç‰©ï¼ˆé è¨­ï¼‰', credit: '', source: 'fallback' };
        }


        // ä¿®æ”¹ getOutfitsByStyleï¼šä»¥ genderTokens çµ„åˆ clothing æŸ¥è©¢ï¼Œæå‡æ€§åˆ¥å°æ‡‰
        async function getOutfitsByStyle(style, gender, trend, occasion, bodyTokens = [], weatherTokens = []) {
            const styleToken = (style && style.trim()) ? (STYLE_TOKEN[style.trim()] || style.trim().toLowerCase()) : 'minimalist';
            const tokens = genderTokens(gender);
            const occasionToken = OCCASION_TOKEN[occasion] || occasion || '';
            const trendToken = TREND_TOKEN[trend] || trend || '';
            const ctx = `${bodyTokens.join(' ')} ${weatherTokens.join(' ')}`.trim();

            const makeTerms = (categoryTerms) => {
                const terms = [];
                for (const tk of tokens) {
                    for (const ct of categoryTerms) {
                        terms.push(`${tk} ${ctx} ${ct} ${styleToken} ${occasionToken} ${trendToken}`.trim());
                    }
                }
                for (const ct of categoryTerms) terms.push(`${ctx} ${ct} ${styleToken} ${occasionToken} ${trendToken}`.trim());
                return terms;
            };


            const topsTerms = makeTerms(['upper body shirt', 'upper body top', 'upper body jacket']);
            const bottomsTerms = makeTerms(['lower body pants', 'lower body trousers', 'lower body jeans', 'lower body skirt']);
            const accessoriesTerms = makeTerms(['accessory necklace', 'accessory bracelet', 'accessory earrings']);


            async function fetchCategory(terms, fallbackKey) {
                for (const t of terms) {
                    const r = await fetchOneImage(t);
                    if (r && r.image) return [r];
                }
                // fallback ä½¿ç”¨ defaultOutfits
                const d = defaultOutfits[fallbackKey] && defaultOutfits[fallbackKey][0] ? defaultOutfits[fallbackKey][0] : null;
                return d ? [{ image: d.image, name: d.name, credit: d.credit || '', source: 'fallback' }] : [];
            }


            const [tops, bottoms, accessories] = await Promise.all([
                fetchCategory(topsTerms, 'casual'),
                fetchCategory(bottomsTerms, 'casual'),
                fetchCategory(accessoriesTerms, 'casual')
            ]);


            // ç¤ºæ„äººç‰©ï¼ˆç¶­æŒåŸæœ¬é‚è¼¯ï¼‰
            const person = await fetchPersonImage(gender, styleToken, trend, occasion, bodyTokens, weatherTokens);


            return { tops, bottoms, accessories, person };
        }


        // ä¿®æ”¹ generateOutfitï¼šä¸å†è®€å–æˆ–ä½¿ç”¨ ethnicity
        async function generateOutfit(data) {
            const target = document.getElementById('outfitResult');
            target.innerHTML = `<div class="loading-overlay"><div class="loader"><div class="spinner"></div><div>AI æ­£åœ¨åˆ†ææ‚¨çš„å€‹äººæ¢ä»¶ä¸¦ç”Ÿæˆå°ˆæ¥­ç©¿æ­å»ºè­°â€¦</div></div></div>`;


            try {
                const trend = data.trend || '';
                const occasion = data.occasion || '';
                const style = data.style || '';


                const bodyTokens = deriveBodyTokens(data.height, data.weight);
                const weatherTokens = data.weatherTokens || [];


                const groups = await getOutfitsByStyle(style, data.gender, trend, occasion, bodyTokens, weatherTokens);


                const uploadedSrc = document.getElementById('photoPreview') && document.getElementById('photoPreview').src && document.getElementById('photoPreview').style.display !== 'none'
                    ? document.getElementById('photoPreview').src
                    : null;


                let personImg = groups.person && groups.person.image ? groups.person.image : null;
                let personCredit = groups.person && groups.person.credit ? groups.person.credit : '';
                let personSource = groups.person && groups.person.source ? groups.person.source : '';


                const genderText = data.gender === 'male' ? 'ç”·æ€§' : data.gender === 'female' ? 'å¥³æ€§' : 'ä¸­æ€§';
                const occasionText = occasion || 'æ—¥å¸¸å ´åˆ';
                const styleText = style || 'ç°¡ç´„é¢¨æ ¼';
                const trendText = trend || 'ç¶“å…¸æ¬¾å¼';


                let aiDesc = '';
                if (personSource && personSource !== 'fallback') {
                    aiDesc = `
                        <div style="font-size:18px;color:var(--text);line-height:2.2;font-family:'Noto Sans TC','Segoe UI',Arial,sans-serif;margin-bottom:24px;">
                            <strong style="font-size:20px;">ğŸ¯ AI å°ˆæ¥­ç©¿æ­åˆ†æ</strong><br><br>
                            æ ¹æ“šæ‚¨æä¾›çš„èº«å½¢æ•¸æ“šï¼ˆèº«é«˜ ${data.height}cmã€é«”é‡ ${data.weight}kgï¼‰ä»¥åŠå€‹äººé¢¨æ ¼åå¥½ï¼ŒAI ç‚ºæ‚¨ç²¾é¸äº†é€™å¥—${genderText}ç©¿æ­ç¤ºæ„ã€‚<br><br>
                            ï¼ˆç¤ºæ„äººç‰©åœ–ç‰‡ä¾†æºï¼š${personSource}ï¼‰
                        </div>
                    `;
                } else {
                    aiDesc = `
                        <div style="font-size:18px;color:var(--text);line-height:2.2;font-family:'Noto Sans TC','Segoe UI',Arial,sans-serif;margin-bottom:24px;">
                            <strong style="font-size:20px;">ğŸ¯ AI å°ˆæ¥­ç©¿æ­åˆ†æ</strong><br><br>
                            ç›®å‰ä½¿ç”¨ç³»çµ±ç¤ºæ„äººç‰©åœ–ç‰‡ï¼ˆå›  API æˆ–ç†±éˆé˜»æ“‹æœªå–å¾—å¤–éƒ¨åœ–ç‰‡ï¼‰ã€‚<br><br>
                        </div>
                    `;
                }


                // åœ¨ <img> ä¸ŠåŠ å…¥ onerrorï¼šè‹¥è¼‰å…¥å¤±æ•—è‡ªå‹•æ›¿æ›ç‚º FALLBACK_PERSON_IMAGE ä¸¦åœ¨ä¸‹æ–¹é¡¯ç¤ºæé†’ï¼ˆç°¡æ˜“å…§è¯è™•ç†ï¼‰
                const personImgTag = personImg
                    ? `<img src="${personImg}" alt="person" onerror="this.onerror=null;this.src='${FALLBACK_PERSON_IMAGE}'; this.nextElementSibling && (this.nextElementSibling.textContent='ç¤ºæ„äººç‰©åœ–ç‰‡å·²æ›¿æ›ç‚ºé è¨­åœ–(å¯èƒ½å›  hotlink/CORS è¢«é˜»æ“‹)');">`
                    : `<div style="width:100%;height:520px;display:flex;align-items:center;justify-content:center;color:var(--muted);background:#181a1b;border-radius:14px;">ç„¡ç¤ºæ„äººç‰©åœ–</div>`;


                const compositeHtml = `
                    ${aiDesc}
                    <div class="composite-row">
                        <div class="uploaded-preview">
                            <div style="color:var(--muted);font-size:16px;margin-bottom:12px;font-weight:500;">æ‚¨çš„ç…§ç‰‡</div>
                            ${uploadedSrc ? `<img src="${uploadedSrc}" alt="uploaded">` : `<div style="width:100%;height:520px;display:flex;align-items:center;justify-content:center;color:var(--muted);background:#181a1b;border-radius:14px;">å°šæœªä¸Šå‚³ç…§ç‰‡</div>`}
                        </div>
                        <div class="composite-preview">
                            <div style="color:var(--muted);font-size:16px;margin-bottom:12px;font-weight:500;">AI ç¤ºæ„äººç‰©</div>
                            ${personImgTag}
                            <div style="font-size:14px;color:var(--muted);margin-top:14px;">${personCredit || ''} ${personSource ? `Â· ä¾†æºï¼š${personSource}` : ''}</div>
                            <div style="font-size:13px;color:#ffb070;margin-top:6px;"></div>
                        </div>
                    </div>
                `;


                target.innerHTML = compositeHtml;


            } catch (err) {
                console.error(err);
                target.innerHTML = '<p>ç„¡æ³•è¼‰å…¥ç¤ºæ„åœ–ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</p>';
            }
        }


        // ä½¿ç”¨ Nominatim (OpenStreetMap) åšåœ°ç†ç·¨ç¢¼ï¼Œç„¶å¾Œå‘¼å« Open-Meteo å–å¾—æº«åº¦èˆ‡æ¿•åº¦
        async function fetchWeather(location) {
            if (!location) throw new Error('no location');
            const q = encodeURIComponent(location);
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`;
            const geoRes = await fetch(geocodeUrl);
            const geoJson = await geoRes.json();
            if (!geoJson || !geoJson[0]) throw new Error('location not found');
            const lat = geoJson[0].lat;
            const lon = geoJson[0].lon;
            const displayName = geoJson[0].display_name || location;


            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=relativehumidity_2m&current_weather=true&timezone=auto`;
            const wRes = await fetch(weatherUrl);
            const wJson = await wRes.json();
            const temp = wJson.current_weather && wJson.current_weather.temperature !== undefined ? wJson.current_weather.temperature : null;


            // å¾ hourly æ‰¾å‡ºæœ€æ¥è¿‘ç¾åœ¨æ™‚é–“çš„æ¿•åº¦å€¼ï¼ˆè‹¥å­˜åœ¨ï¼‰
            let humidity = null;
            if (wJson.hourly && Array.isArray(wJson.hourly.time) && Array.isArray(wJson.hourly.relativehumidity_2m)) {
                const times = wJson.hourly.time.map(t => new Date(t).getTime());
                const now = Date.now();
                let idx = 0, minDiff = Infinity;
                times.forEach((ms, i) => {
                    const d = Math.abs(ms - now);
                    if (d < minDiff) { minDiff = d; idx = i; }
                });
                humidity = wJson.hourly.relativehumidity_2m[idx];
            }


            const numericTemp = temp !== null && Number.isFinite(Number(temp)) ? Number(temp) : null;

            return {
                temperature: numericTemp,
                humidity: humidity !== null ? Math.round(humidity) : null,
                name: displayName
            };
        }


        // ç…§ç‰‡ä¸Šå‚³è™•ç†
        const photoUploadArea = document.getElementById('photoUploadArea');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const resetPhotoBtn = document.getElementById('resetPhotoBtn');


        photoUploadArea.addEventListener('click', (e) => {
            // é¿å…é»æ“Šé‡é¸æŒ‰éˆ•æ™‚è§¸ç™¼ä¸Šå‚³
            if (e.target.id !== 'resetPhotoBtn') {
                photoInput.click();
            }
        });


        photoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoUploadArea.style.background = 'rgba(255, 236, 224, 0.1)';
        });


        photoUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            photoUploadArea.style.background = 'rgba(255, 236, 224, 0.05)';
        });


        photoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handlePhotoUpload(file);
            }
        });


        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handlePhotoUpload(file);
            }
        });


        function handlePhotoUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                photoPreview.src = e.target.result;
                photoPreview.style.display = 'block';
                photoUploadArea.querySelector('p').style.display = 'none';
                photoUploadArea.querySelector('.upload-icon').style.display = 'none';
                resetPhotoBtn.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }

        // æ–°å¢ï¼šé‡é¸ç…§ç‰‡åŠŸèƒ½
        resetPhotoBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            photoPreview.src = '';
            photoPreview.style.display = 'none';
            photoInput.value = '';
            photoUploadArea.querySelector('p').style.display = 'block';
            photoUploadArea.querySelector('.upload-icon').style.display = 'block';
            resetPhotoBtn.style.display = 'none';
        });
    </script>
</body>
</html>

