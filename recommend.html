<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æ™‚å°šç©¿æ­æ¨è–¦</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg1: #181a1b;
            --bg2: #232526;
            --card: #232526;
            --accent1: #fff;
            --accent2: #bbb;
            --text: #f5f5f5;
            --muted: #aaa;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg1), var(--bg2));
            color: var(--text);
            padding: 0;
            display: flex;
            align-items: start;
            justify-content: center;
        }

        .container {
            width: 100vw;
            max-width: 1600px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            padding: 48px 24px 24px 24px;
            height: auto;
            margin-top: 56px;
        }

        .panel {
            background: var(--card);
            border-radius: 16px;
            padding: 32px 28px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.12);
            border: 1px solid #222;
        }

        .title {
            font-size: 26px;
            color: var(--text);
            margin-bottom: 14px;
            font-weight: 700;
            letter-spacing: 0.5px;
            font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
        }
        .subtitle {
            font-size: 16px;
            color: var(--muted);
            margin-bottom: 28px;
            line-height: 1.8;
            font-family: 'Noto Sans TC', 'Segoe UI', Arial, sans-serif;
        }
        .result-card {
            background: var(--card);
            border-radius: 14px;
            padding: 28px;
            border: 1px solid #222;
            box-shadow: 0 2px 16px rgba(0,0,0,0.18);
        }

        .composite-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-top: 24px;
        }
        .uploaded-preview, .composite-preview {
            width: 100%;
            background: #222;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 2px 12px rgba(0,0,0,0.22);
        }
        .uploaded-preview img, .composite-preview img {
            width: 100%;
            height: 520px;
            object-fit: contain;
            border-radius: 14px;
            background: #1a1c1d;
        }

        .back-home {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            top: 18px;
            padding: 8px 24px;
            background: #222;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            border: none;
        }
        .back-home:hover {
            background: #444;
        }

        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .input, .select {
            width: 100%;
            padding: 10px 12px;
            background: #181a1b;
            border: 1px solid #333;
            border-radius: 7px;
            color: var(--text);
            font-size: 15px;
        }
        .select option {
            background-color: #222;
            color: var(--text);
        }
        .input::placeholder {
            color: #666;
        }
        .input:focus, .select:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 0 2px #333;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            background: #222;
            color: #fff;
            transition: background 0.2s;
            margin-right: 8px;
        }
        .btn.primary {
            background: #222;
            color: #fff;
            border: 1px solid #333; /* æ–°å¢ï¼šèˆ‡ .btn.secondary ä¸€æ¨£çš„å¤–æ¡† */
        }
        .btn.secondary {
            background: #181a1b;
            color: #fff;
            border: 1px solid #333;
        }
        .btn:hover {
            background: #444;
            color: #fff;
        }

        /* æ–°å¢ï¼šç½®ä¸­è¡¨å–®æœ«ç«¯æŒ‰éˆ•ï¼ˆç”Ÿæˆ / é‡æ–°è¨­å®šï¼‰ä¸¦ä½¿ç”¨ gap æ§åˆ¶é–“è· */
        .search-form .form-group:last-child {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 8px;
            transform: translateX(-0.35cm); /* å‘å³ç§» 0.25cmï¼ˆå·²ä¿®æ”¹ï¼‰ */
        }
        .search-form .form-group:last-child .btn {
            margin-right: 0;
        }

        .photo-upload {
            background: #181a1b;
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 18px;
            color: var(--muted);
        }
        .photo-upload:hover {
            background: #222;
        }
        .photo-preview {
            max-width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            display: none;
            margin-top: 8px;
            background: #181a1b;
        }
        .upload-icon {
            font-size: 40px;
            color: var(--muted);
        }

        .loading-overlay {
            position: relative;
            min-height: 120px;
        }
        .loading-overlay .loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.28);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            gap: 10px;
        }
        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #333;
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 980px) {
            .container {
                grid-template-columns: 1fr;
            }
            .composite-row {
                grid-template-columns: 1fr;
            }
            .uploaded-preview img, .composite-preview img {
                height: 360px;
            }
        }
    </style>
</head>
<body>
    <!-- ç§»å‹•è¿”å›æŒ‰éˆ•åˆ°é ‚éƒ¨ä¸­é–“ -->
    <a href="index.html" class="back-home">è¿”å›é¦–é </a>

    <div class="container">
        <!-- å·¦å´çµæœé¢æ¿ -->
        <div class="panel">
            <h1 class="title">ä»Šæ—¥ç©¿æ­æ¨è–¦</h1>
            <p class="subtitle">æ ¹æ“šæ‚¨çš„å€‹äººç‰¹å¾µèˆ‡ç•¶åœ°å¤©æ°£ï¼Œç‚ºæ‚¨æ¨è–¦æœ€é©åˆçš„ç©¿æ­çµ„åˆã€‚</p>

            <div class="result-card">
                <div id="outfitResult">
                    <!-- å‹•æ…‹ç”Ÿæˆç©¿æ­é è¦½ -->
                </div>

                <!-- å¤©æ°£é¡¯ç¤ºå€ -->
                <div id="weatherInfo" style="margin-top:12px;color:var(--muted);font-size:14px">
                    <!-- å¤©æ°£è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                </div>
            </div>
        </div>

        <!-- å³å´è¨­å®šé¢æ¿ -->
        <div class="panel">
            <h2 class="title">æ­é…æ¢ä»¶è¨­å®š</h2>
            <p class="subtitle">è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨æ¨è–¦æœ€é©åˆçš„ç©¿æ­ã€‚</p>

            <!-- ä¿®æ”¹ï¼šåœ¨è¡¨å–®ä¸­æ–°å¢æ—ç¾¤é¸æ“‡ -->
            <form class="search-form" id="outfitForm">
                <div class="form-group">
                    <label>ä¸Šå‚³æ‚¨çš„ç…§ç‰‡</label>
                    <div class="photo-upload" id="photoUploadArea">
                        <span class="material-icons upload-icon">cloud_upload</span>
                        <p style="margin-top: 10px; color: var(--muted);">é»æ“Šæˆ–æ‹–æ›³ç…§ç‰‡è‡³æ­¤è™•</p>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <img id="photoPreview" class="photo-preview">
                    </div>
                </div>

                <div class="form-group">
                    <label>æ€§åˆ¥</label>
                    <select class="select" name="gender" required>
                        <option value="male">ç”·è£</option>
                        <option value="female">å¥³è£</option>
                        <option value="unisex">ä¸­æ€§é¢¨æ ¼</option>
                    </select>
                </div>

                <!-- æ–°å¢æµè¡Œé¢¨æ ¼é¸æ“‡ -->
                <div class="form-group">
                    <label>æµè¡Œé¢¨æ ¼</label>
                    <select class="select" name="trend">
                        <option value="">ä¸æŒ‡å®š</option>
                        <option value="korean">éŸ“ç³»</option>
                        <option value="japanese">æ—¥ç³»</option>
                        <option value="american">ç¾ç³»</option>
                        <option value="european">æ­ç³»</option>
                    </select>
                </div>

                <!-- æ–°å¢ç©¿è‘—å–œå¥½é¸æ“‡ -->
                <div class="form-group">
                    <label>ç©¿è‘—å–œå¥½</label>
                    <select class="select" name="style">
                        <option value="">ä¸æŒ‡å®š</option>
                        <option value="casual">ä¼‘é–’é¢¨</option>
                        <option value="punk">é¾å…‹é¢¨</option>
                        <option value="minimalist">ç°¡ç´„é¢¨</option>
                        <option value="vintage">å¾©å¤é¢¨</option>
                        <option value="sporty">é‹å‹•é¢¨</option>
                        <option value="street">è¡—é ­é¢¨</option>
                        <option value="bohemian">æ³¢å¸Œç±³äºé¢¨</option>
                        <option value="preppy">å­¸é™¢é¢¨</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å ´åˆé¸æ“‡</label>
                    <select class="select" name="occasion" required>
                        <option value="">è«‹é¸æ“‡å ´åˆ</option>
                        <option value="daily">æ—¥å¸¸ä¼‘é–’</option>
                        <option value="work">å·¥ä½œå ´åˆ</option>
                        <option value="date">ç´„æœƒ</option>
                        <option value="party">æ´¾å°èšæœƒ</option>
                        <option value="ceremony">æ­£å¼å…¸ç¦®</option>
                        <option value="sports">é‹å‹•å¥èº«</option>
                        <option value="travel">æ—…éŠå‡ºéŠ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>èº«é«˜ (cm)</label>
                    <input type="number" class="input" name="height" placeholder="è«‹è¼¸å…¥èº«é«˜" required>
                </div>

                <div class="form-group">
                    <label>é«”é‡ (kg)</label>
                    <input type="number" class="input" name="weight" placeholder="è«‹è¼¸å…¥é«”é‡" required>
                </div>

                <div class="form-group">
                    <label>æ‰€åœ¨åœ°å€</label>
                    <input type="text" class="input" name="location" placeholder="è¼¸å…¥åŸå¸‚åç¨±" required>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn primary">ç”Ÿæˆç©¿æ­å»ºè­°</button>
                    <button type="reset" class="btn secondary">é‡æ–°è¨­å®š</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Unsplash èˆ‡ Pexels API Keyï¼ˆPexels å¯ç”³è«‹å…è²» keyï¼Œé€™è£¡ç”¨ demo keyï¼‰
        const UNSPLASH_ACCESS_KEY = 'AMSaKomiM1b5LLX57gpT-TxdE0TQ4kHCmaf_b4iORTI';
        const PEXELS_ACCESS_KEY = '563492ad6f91700001000001'; // demo key, è«‹æ›æˆè‡ªå·±çš„æ­£å¼ key

        // æ–°å¢é è¨­ç©¿æ­ï¼Œä»¥é˜² API è«‹æ±‚å¤±æ•—
        const defaultOutfits = {
            casual: [
                { image: 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f', name: 'ä¼‘é–’ç©¿æ­', description: 'æ—¥å¸¸ä¼‘é–’é¢¨æ ¼' },
                { image: 'https://images.unsplash.com/photo-1523381210434-271e8be1f52b', name: 'è¡—é ­é¢¨æ ¼', description: 'è¡—é ­ä¼‘é–’æ­é…' },
                { image: 'https://images.unsplash.com/photo-1492707892479-7bc8d5a4ee93', name: 'è¼•ä¾¿æ­é…', description: 'è¼•é¬†è‡ªåœ¨é¢¨æ ¼' }
            ],
            formal: [
                { image: 'https://images.unsplash.com/photo-1553484771-371a605b060b', name: 'æ­£å¼ç©¿æ­', description: 'å•†å‹™æ­£å¼é¢¨æ ¼' },
                { image: 'https://images.unsplash.com/photo-1553484771-8bbd4e16c6a2', name: 'è¥¿è£å¥—è£', description: 'è·å ´æ­£å¼æ­é…' },
                { image: 'https://images.unsplash.com/photo-1553484771-8bbd4e16c6a3', name: 'å•†å‹™ä¾¿è£', description: 'å•†å‹™ä¼‘é–’é¢¨æ ¼' }
            ]
        };

        // è¡¨å–®æäº¤è™•ç† + å–å¾—å¤©æ°£
        document.getElementById('outfitForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // æ”¶é›†è¡¨å–®è³‡æ–™
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // å…ˆå˜—è©¦å–å¾—åœ°å€å¤©æ°£ï¼Œå†ç”Ÿæˆç©¿æ­
            const weatherTarget = document.getElementById('weatherInfo');
            weatherTarget.textContent = 'æ­£åœ¨æŸ¥è©¢å¤©æ°£...';
            try {
                const weather = await fetchWeather(data.location);
                weatherTarget.innerHTML = `<strong>å¤©æ°£ï¼ˆ${weather.name.split(',')[0]}ï¼‰</strong>ï¼šæº«åº¦ ${weather.temperature}Â°Cï¼Œæ¿•åº¦ ${weather.humidity !== null ? weather.humidity + '%' : 'â€”'}`;
            } catch (err) {
                weatherTarget.textContent = 'ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™';
                console.warn(err);
            }

            // ç”Ÿæˆç©¿æ­å»ºè­°
            generateOutfit(data);
        });

        // å„ªåŒ– fetchOneImageï¼šå…ˆç”¨ Unsplashï¼Œè‹¥å¤±æ•—å‰‡ç”¨ Pexels
        async function fetchOneImage(term) {
            // å…ˆç”¨ Unsplash
            try {
                const res = await fetch(`https://api.unsplash.com/photos/random?query=${encodeURIComponent(term)}&orientation=portrait`, {
                    headers: { 'Authorization': `Client-ID ${UNSPLASH_ACCESS_KEY}` }
                });
                const j = await res.json();
                if (j && j.urls && j.urls.regular) {
                    return {
                        image: j.urls.regular,
                        name: j.alt_description || term,
                        credit: j.user && j.user.name ? `Photo by ${j.user.name} on Unsplash` : ''
                    };
                }
            } catch (e) {
                // å¿½ç•¥
            }
            // è‹¥ Unsplash å¤±æ•—ï¼Œæ”¹ç”¨ Pexels
            try {
                const res2 = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(term)}&orientation=portrait&per_page=1`, {
                    headers: { 'Authorization': PEXELS_ACCESS_KEY }
                });
                const j2 = await res2.json();
                if (j2 && j2.photos && j2.photos.length > 0) {
                    const p = j2.photos[0];
                    return {
                        image: p.src && p.src.large ? p.src.large : null,
                        name: p.alt || term,
                        credit: p.photographer ? `Photo by ${p.photographer} on Pexels` : ''
                    };
                }
            } catch (e) {
                // å¿½ç•¥
            }
            return null;
        }

        // å° helperï¼šæŠŠæ€§åˆ¥å€¼è½‰ç‚ºä¸­æ–‡é¡¯ç¤º
        function genderLabelText(g) {
            if (!g) return 'ä¸­æ€§';
            if (g === 'male') return 'ç”·ç”Ÿ';
            if (g === 'female') return 'å¥³ç”Ÿ';
            return 'ä¸­æ€§';
        }

        // çµ±ä¸€ fetchPersonImageï¼šç§»é™¤ ethnicityï¼Œä½¿ç”¨ gender/style/trend/occasion
        async function fetchPersonImage(gender, style, trend, occasion) {
            let genderToken = '';
            if (gender === 'male') genderToken = 'male man';
            else if (gender === 'female') genderToken = 'female woman';
            else genderToken = 'unisex person';

            const occasionToken = occasion ? ` ${occasion}` : '';
            const trendToken = trend ? ` ${trend}` : '';
            const styleToken = style ? ` ${style}` : '';

            const personQueries = [
                `${genderToken}${occasionToken}${trendToken}${styleToken} fashion model outfit`,
                `${genderToken}${occasionToken}${styleToken} person wearing outfit`,
                `${genderToken} fashion model${occasionToken}${trendToken}${styleToken}`,
                `${genderToken}${occasionToken} outfit portrait`
            ];

            for (const q of personQueries) {
                const r = await fetchOneImage(q);
                if (r && r.image) return r;
            }
            return null;
        }

        // å„ªåŒ– getOutfitsByStyleï¼šç§»é™¤ ethnicityï¼Œæ–°å¢ trend/occasion åƒæ•¸ä»¥ä¾¿å‚³éçµ¦ fetchPersonImage
        async function getOutfitsByStyle(style, gender, trend, occasion) {
            const styleToken = (style && style.trim()) ? style.trim().toLowerCase() : 'minimalist';

            const topsTerms = [
                `${gender} upper body shirt ${styleToken}`,
                `${gender} upper body top ${styleToken}`,
                `${gender} upper body jacket ${styleToken}`
            ];
            const bottomsTerms = [
                `${gender} lower body pants ${styleToken}`,
                `${gender} lower body trousers ${styleToken}`,
                `${gender} lower body jeans ${styleToken}`,
                `${gender} lower body skirt ${styleToken}`
            ];
            const accessoriesTerms = [
                `${gender} accessory necklace ${styleToken}`,
                `${gender} accessory bracelet ${styleToken}`,
                `${gender} accessory earrings ${styleToken}`
            ];

            async function fetchCategory(terms, fallbackKey) {
                for (const t of terms) {
                    const r = await fetchOneImage(t);
                    if (r && r.image) return [r];
                }
                // fallback ä½¿ç”¨ defaultOutfits
                const d = defaultOutfits[fallbackKey] && defaultOutfits[fallbackKey][0] ? defaultOutfits[fallbackKey][0] : null;
                return d ? [{ image: d.image, name: d.name, credit: d.credit || '' }] : [];
            }

            const [tops, bottoms, accessories] = await Promise.all([
                fetchCategory(topsTerms, 'casual'),
                fetchCategory(bottomsTerms, 'casual'),
                fetchCategory(accessoriesTerms, 'casual')
            ]);

            // ç¤ºæ„äººç‰©ï¼ˆç¶­æŒåŸæœ¬é‚è¼¯ï¼‰
            const person = await fetchPersonImage(gender, styleToken, trend, occasion);

            return { tops, bottoms, accessories, person };
        }

        // ä¿®æ”¹ generateOutfitï¼šä¸å†è®€å–æˆ–ä½¿ç”¨ ethnicity
        async function generateOutfit(data) {
            const target = document.getElementById('outfitResult');
            target.innerHTML = `<div class="loading-overlay"><div class="loader"><div class="spinner"></div><div>AI æ­£åœ¨åˆ†ææ‚¨çš„å€‹äººæ¢ä»¶ä¸¦ç”Ÿæˆå°ˆæ¥­ç©¿æ­å»ºè­°â€¦</div></div></div>`;

            try {
                const trend = data.trend || '';
                const occasion = data.occasion || '';
                const style = data.style || '';

                // å‚³é trend/occasion çµ¦ getOutfitsByStyle
                const groups = await getOutfitsByStyle(style, data.gender, trend, occasion);

                const uploadedSrc = document.getElementById('photoPreview') && document.getElementById('photoPreview').src && document.getElementById('photoPreview').style.display !== 'none'
                    ? document.getElementById('photoPreview').src
                    : null;

                let personImg = groups.person && groups.person.image ? groups.person.image : null;
                let personCredit = groups.person && groups.person.credit ? groups.person.credit : '';

                const genderText = data.gender === 'male' ? 'ç”·æ€§' : data.gender === 'female' ? 'å¥³æ€§' : 'ä¸­æ€§';
                const occasionText = occasion || 'æ—¥å¸¸å ´åˆ';
                const styleText = style || 'ç°¡ç´„é¢¨æ ¼';
                const trendText = trend || 'ç¶“å…¸æ¬¾å¼';

                let aiDesc = '';
                if (personImg) {
                    aiDesc = `
                        <div style="font-size:18px;color:var(--text);line-height:2.2;font-family:'Noto Sans TC','Segoe UI',Arial,sans-serif;margin-bottom:24px;">
                            <strong style="font-size:20px;">ğŸ¯ AI å°ˆæ¥­ç©¿æ­åˆ†æ</strong><br><br>
                            æ ¹æ“šæ‚¨æä¾›çš„èº«å½¢æ•¸æ“šï¼ˆèº«é«˜ ${data.height}cmã€é«”é‡ ${data.weight}kgï¼‰ä»¥åŠå€‹äººé¢¨æ ¼åå¥½ï¼ŒAI ç‚ºæ‚¨ç²¾é¸äº†é€™å¥—${genderText}ç©¿æ­ç¤ºæ„ã€‚<br><br>
                            
                            <strong>â–¸ æ•´é«”é¢¨æ ¼è§£æï¼š</strong><br>
                            é€™å¥—æ­é…èåˆäº†ã€Œ${trendText}ã€èˆ‡ã€Œ${styleText}ã€çš„è¨­è¨ˆèªå½™ï¼Œç‰¹åˆ¥é‡å°ã€Œ${occasionText}ã€å ´æ™¯é‡èº«æ‰“é€ ã€‚æœè£å‰ªè£ç·šæ¢ä¿è½åˆ†æ˜ï¼Œç‰ˆå‹æ¯”ä¾‹ç¶“éç²¾ç®—ï¼Œèƒ½å®Œç¾ä¿®é£¾èº«å½¢ï¼ŒåŒæ™‚ä¿æŒèˆ’é©åº¦èˆ‡éˆæ´»æ€§ã€‚<br><br>
                            
                            <strong>â–¸ ç‚ºä»€éº¼æ¨è–¦é€™å¥—ï¼Ÿ</strong><br>
                            è‰²å½©æ­é…ä¸Šæ¡ç”¨å”èª¿æ¼¸å±¤æˆ–æ’è‰²æ‰‹æ³•ï¼Œæ—¢ä¸éæ–¼å¼µæšä¹Ÿä¸æœƒå¤ªéä½èª¿ï¼Œæ°åˆ°å¥½è™•åœ°å±•ç¾å€‹äººå“å‘³ã€‚é…ä»¶èˆ‡ç´°ç¯€è™•ç†æ›´æ˜¯ç•«é¾é»ç›ï¼Œæå‡æ•´é«”è³ªæ„Ÿçš„åŒæ™‚ä¹Ÿèƒ½å‡¸é¡¯æ‚¨çš„æ™‚å°šæ•éŠ³åº¦ã€‚<br><br>
                            
                            <strong>â–¸ å¯¦ç©¿å»ºè­°ï¼š</strong><br>
                            é€™æ¨£çš„ç©¿æ­ä¸åƒ…é©åˆ${occasionText}ï¼Œç¨ä½œèª¿æ•´ä¹Ÿèƒ½æ‡‰ç”¨æ–¼å…¶ä»–å ´åˆã€‚å»ºè­°æ‚¨å¯ä»¥åƒè€ƒç¤ºæ„åœ–çš„é…è‰²èˆ‡å±¤æ¬¡æ„Ÿï¼ŒæŒ‘é¸ç¬¦åˆè‡ªå·±è†šè‰²èˆ‡èº«å½¢çš„å–®å“ï¼Œæ‰“é€ å±¬æ–¼è‡ªå·±çš„å°ˆå±¬é¢¨æ ¼ã€‚è¨˜ä½ï¼Œæœ€å¥½çš„ç©¿æ­æ°¸é æ˜¯è®“ä½ è‡ªä¿¡åˆè‡ªåœ¨çš„é‚£ä¸€å¥—ï¼
                        </div>
                    `;
                } else {
                    aiDesc = `
                        <div style="font-size:18px;color:var(--text);line-height:2.2;font-family:'Noto Sans TC','Segoe UI',Arial,sans-serif;margin-bottom:24px;">
                            <strong style="font-size:20px;">ğŸ¯ AI å°ˆæ¥­ç©¿æ­åˆ†æ</strong><br><br>
                            å¾ˆæŠ±æ­‰ç›®å‰ç„¡æ³•ç‚ºæ‚¨æ‰¾åˆ°åˆé©çš„ç¤ºæ„äººç‰©åœ–ç‰‡ï¼Œä¸éåˆ¥æ“”å¿ƒï¼æ ¹æ“šæ‚¨çš„æ¢ä»¶èˆ‡åå¥½ï¼ŒAI ä¾ç„¶èƒ½çµ¦æ‚¨å°ˆæ¥­çš„ç©¿æ­å»ºè­°ã€‚<br><br>
                            
                            å»ºè­°æ‚¨é¸æ“‡å‰ªè£ä¿è½ã€è³ªæ„Ÿç´°è†©çš„å–®å“ï¼Œæ­é…ç°¡ç´„ä½†å…·è¨­è¨ˆæ„Ÿçš„é…ä»¶ã€‚è¨˜å¾—æœè£æœ€é‡è¦çš„æ˜¯åˆèº«èˆ‡èˆ’é©ï¼Œå†æ­é…é©ç•¶çš„è‰²å½©çµ„åˆï¼Œå°±èƒ½è¼•é¬†å±•ç¾å°ˆæ¥­æ™‚å°šæ„Ÿã€‚<br><br>
                            
                            æ‚¨å¯ä»¥ç¨å¾Œå†è©¦è©¦çœ‹ï¼Œæˆ–æ˜¯èª¿æ•´ä¸€ä¸‹æœå°‹æ¢ä»¶ï¼ˆä¾‹å¦‚é¢¨æ ¼ã€å ´åˆç­‰ï¼‰ï¼Œè®“ AI ç‚ºæ‚¨æ‰¾åˆ°æ›´è²¼è¿‘éœ€æ±‚çš„ç©¿æ­éˆæ„Ÿï¼
                        </div>
                    `;
                }

                const compositeHtml = `
                    ${aiDesc}
                    <div class="composite-row">
                        <div class="uploaded-preview">
                            <div style="color:var(--muted);font-size:16px;margin-bottom:12px;font-weight:500;">æ‚¨çš„ç…§ç‰‡</div>
                            ${uploadedSrc ? `<img src="${uploadedSrc}" alt="uploaded">` : `<div style="width:100%;height:520px;display:flex;align-items:center;justify-content:center;color:var(--muted);background:#181a1b;border-radius:14px;">å°šæœªä¸Šå‚³ç…§ç‰‡</div>`}
                        </div>
                        <div class="composite-preview">
                            <div style="color:var(--muted);font-size:16px;margin-bottom:12px;font-weight:500;">AI ç¤ºæ„äººç‰©</div>
                            ${personImg ? `<img src="${personImg}" alt="person">` : `<div style="width:100%;height:520px;display:flex;align-items:center;justify-content:center;color:var(--muted);background:#181a1b;border-radius:14px;">ç„¡ç¤ºæ„äººç‰©åœ–</div>`}
                            <div style="font-size:14px;color:var(--muted);margin-top:14px;">${personCredit || ''}</div>
                        </div>
                    </div>
                `;

                target.innerHTML = compositeHtml;

            } catch (err) {
                console.error(err);
                target.innerHTML = '<p>ç„¡æ³•è¼‰å…¥ç¤ºæ„åœ–ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</p>';
            }
        }

        // ä½¿ç”¨ Nominatim (OpenStreetMap) åšåœ°ç†ç·¨ç¢¼ï¼Œç„¶å¾Œå‘¼å« Open-Meteo å–å¾—æº«åº¦èˆ‡æ¿•åº¦
        async function fetchWeather(location) {
            if (!location) throw new Error('no location');
            const q = encodeURIComponent(location);
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`;
            const geoRes = await fetch(geocodeUrl);
            const geoJson = await geoRes.json();
            if (!geoJson || !geoJson[0]) throw new Error('location not found');
            const lat = geoJson[0].lat;
            const lon = geoJson[0].lon;
            const displayName = geoJson[0].display_name || location;

            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=relativehumidity_2m&current_weather=true&timezone=auto`;
            const wRes = await fetch(weatherUrl);
            const wJson = await wRes.json();
            const temp = wJson.current_weather && wJson.current_weather.temperature !== undefined ? wJson.current_weather.temperature : null;

            // å¾ hourly æ‰¾å‡ºæœ€æ¥è¿‘ç¾åœ¨æ™‚é–“çš„æ¿•åº¦å€¼ï¼ˆè‹¥å­˜åœ¨ï¼‰
            let humidity = null;
            if (wJson.hourly && Array.isArray(wJson.hourly.time) && Array.isArray(wJson.hourly.relativehumidity_2m)) {
                const times = wJson.hourly.time.map(t => new Date(t).getTime());
                const now = Date.now();
                let idx = 0, minDiff = Infinity;
                times.forEach((ms, i) => {
                    const d = Math.abs(ms - now);
                    if (d < minDiff) { minDiff = d; idx = i; }
                });
                humidity = wJson.hourly.relativehumidity_2m[idx];
            }

            return {
                temperature: temp !== null ? Number(temp).toFixed(1) : 'â€”',
                humidity: humidity !== null ? Math.round(humidity) : null,
                name: displayName
            };
        }

        // ç…§ç‰‡ä¸Šå‚³è™•ç†
        const photoUploadArea = document.getElementById('photoUploadArea');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');

        photoUploadArea.addEventListener('click', () => photoInput.click());

        photoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoUploadArea.style.background = 'rgba(255, 236, 224, 0.1)';
        });

        photoUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            photoUploadArea.style.background = 'rgba(255, 236, 224, 0.05)';
        });

        photoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handlePhotoUpload(file);
            }
        });

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handlePhotoUpload(file);
            }
        });

        function handlePhotoUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                photoPreview.src = e.target.result;
                photoPreview.style.display = 'block';
                photoUploadArea.querySelector('p').style.display = 'none';
                photoUploadArea.querySelector('.upload-icon').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>